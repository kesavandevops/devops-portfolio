pipeline {
  agent any

  environment {
    AWS_DEFAULT_REGION = "ap-south-1"
    TF_WORKDIR = "05-serverless-aws/terraform"
    BUILD_DIR = "05-serverless-aws"

    // Make Terraform fully non-interactive in CI
    TF_INPUT = '0'
    AWS_EC2_METADATA_DISABLED = 'true'

    // Plugin cache to speed up provider loading
    TF_PLUGIN_CACHE_DIR = "${WORKSPACE}/.terraform.d/plugin-cache"

    // Default CLI args
    TF_CLI_ARGS_init  = "-input=false -no-color"
    TF_CLI_ARGS_plan  = "-input=false -no-color -lock-timeout=5m"
    TF_CLI_ARGS_apply = "-input=false -no-color -lock-timeout=5m"
  }

  options {
    timeout(time: 5, unit: 'MINUTES')
    timestamps()
  }

  stages {
    stage('Checkout') {
      steps {
        checkout scm
      }
    }

    stage('Build Lambda Package') {
      steps {
        dir("${TF_WORKDIR}/..") {
          sh '''
bash <<EOF
set -euo pipefail
echo "ðŸ—ï¸ Building Lambda packa
