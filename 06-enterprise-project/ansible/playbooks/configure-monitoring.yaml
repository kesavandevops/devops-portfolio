---
- name: Configure Prometheus and Grafana Monitoring Stack
  hosts: localhost
  connection: local
  tasks:
    - name: Set Kubernetes context
      command: aws eks update-kubeconfig --region ap-south-1 --name enterprise-eks-cluster

    - name: Create monitoring namespace
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Namespace
          metadata:
            name: monitoring

    - name: Deploy Prometheus
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: prometheus
            namespace: monitoring
          spec:
            replicas: 1
            selector:
              matchLabels:
                app: prometheus
            template:
              metadata:
                labels:
                  app: prometheus
              spec:
                containers:
                  - name: prometheus
                    image: prom/prometheus:v2.53.0
                    ports:
                      - containerPort: 9090
                    volumeMounts:
                      - name: config
                        mountPath: /etc/prometheus/
                volumes:
                  - name: config
                    configMap:
                      name: prometheus-config

    - name: Prometheus ConfigMap
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: ConfigMap
          metadata:
            name: prometheus-config
            namespace: monitoring
          data:
            prometheus.yml: |
              global:
                scrape_interval: 15s
              scrape_configs:
                - job_name: 'flask-app'
                  static_configs:
                    - targets: ['flask-service.enterprise.svc.cluster.local:80']

    - name: Deploy Prometheus Service
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Service
          metadata:
            name: prometheus
            namespace: monitoring
          spec:
            type: NodePort
            ports:
              - port: 9090
                targetPort: 9090
            selector:
              app: prometheus

    - name: Grafana Datasource ConfigMap
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: ConfigMap
          metadata:
            name: grafana-datasources
            namespace: monitoring
            labels:
              grafana_datasource: "1"
          data:
            prometheus-datasource.yaml: |
              apiVersion: 1
              datasources:
                - name: Prometheus
                  type: prometheus
                  access: proxy
                  url: http://prometheus.monitoring.svc.cluster.local:9090
                  isDefault: true
                  editable: false

    - name: Deploy Grafana
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: grafana
            namespace: monitoring
          spec:
            replicas: 1
            selector:
              matchLabels:
                app: grafana
            template:
              metadata:
                labels:
                  app: grafana
              spec:
                containers:
                  - name: grafana
                    image: grafana/grafana:10.4.0
                    ports:
                      - containerPort: 3000
                    volumeMounts:
                      - name: grafana-datasources
                        mountPath: /etc/grafana/provisioning/datasources
                volumes:
                  - name: grafana-datasources
                    configMap:
                      name: grafana-datasources

    - name: Grafana Service
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Service
          metadata:
            name: grafana
            namespace: monitoring
          spec:
            type: LoadBalancer
            ports:
              - port: 3000
                targetPort: 3000
            selector:
              app: grafana
