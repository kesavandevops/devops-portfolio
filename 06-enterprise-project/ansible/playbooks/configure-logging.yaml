---
- name: Configure Centralized Logging with Splunk and Fluentd
  hosts: localhost
  connection: local
  tasks:
    - name: Set Kubernetes context
      command: aws eks update-kubeconfig --region ap-south-1 --name enterprise-eks-cluster

    - name: Create logging namespace
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Namespace
          metadata:
            name: logging

    - name: Deploy Fluentd DaemonSet
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: apps/v1
          kind: DaemonSet
          metadata:
            name: fluentd
            namespace: logging
          spec:
            selector:
              matchLabels:
                app: fluentd
            template:
              metadata:
                labels:
                  app: fluentd
              spec:
                containers:
                  - name: fluentd
                    image: fluent/fluentd-kubernetes-daemonset:v1.14.6-debian-splunk-1.0
                    env:
                      - name: SPLUNK_HEC_URL
                        value: "https://splunk-enterprise.logging.svc.cluster.local:8088"
                      - name: SPLUNK_HEC_TOKEN
                        value: "splunk-12345-token"
                    resources:
                      limits:
                        memory: "200Mi"
                        cpu: "200m"
                    volumeMounts:
                      - name: varlog
                        mountPath: /var/log
                volumes:
                  - name: varlog
                    hostPath:
                      path: /var/log

    - name: Deploy Splunk Enterprise
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: splunk-enterprise
            namespace: logging
          spec:
            replicas: 1
            selector:
              matchLabels:
                app: splunk
            template:
              metadata:
                labels:
                  app: splunk
              spec:
                containers:
                  - name: splunk
                    image: splunk/splunk:9.2
                    env:
                      - name: SPLUNK_START_ARGS
                        value: "--accept-license"
                      - name: SPLUNK_PASSWORD
                        value: "DevOps@123"
                    ports:
                      - containerPort: 8000
                      - containerPort: 8088

    - name: Splunk Service
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Service
          metadata:
            name: splunk-enterprise
            namespace: logging
          spec:
            type: LoadBalancer
            ports:
              - name: splunk-web
                port: 8000
                targetPort: 8000
              - name: splunk-hec
                port: 8088
                targetPort: 8088
            selector:
              app: splunk

