---
- name: Configure Centralized Logging with Splunk and Fluent Bit
  hosts: localhost
  connection: local
  tasks:
    - name: Set Kubernetes context
      command: aws eks update-kubeconfig --region ap-south-1 --name enterprise-eks-cluster

    - name: Create logging namespace
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Namespace
          metadata:
            name: logging

    - name: Deploy Splunk Enterprise
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: splunk-enterprise
            namespace: logging
          spec:
            replicas: 1
            selector:
              matchLabels:
                app: splunk
            template:
              metadata:
                labels:
                  app: splunk
              spec:
                securityContext:
                  runAsUser: 0
                containers:
                  - name: splunk
                    image: splunk/splunk:9.2
                    env:
                      - name: SPLUNK_START_ARGS
                        value: "--accept-license --answer-yes"
                      - name: SPLUNK_PASSWORD
                        value: "DevOps@123"
                      - name: SPLUNK_HEC_TOKEN
                        value: "my-hec-token"
                      - name: SPLUNK_HEC_PORT
                        value: "8088"
                      - name: SPLUNK_HEC_SSL
                        value: "false"
                    ports:
                      - containerPort: 8000
                      - containerPort: 8088
                    volumeMounts:
                      - name: splunk-etc
                        mountPath: /opt/splunk/etc
                      - name: splunk-var
                        mountPath: /opt/splunk/var
                volumes:
                  - name: splunk-etc
                    emptyDir: {}
                  - name: splunk-var
                    emptyDir: {}

    - name: Deploy Splunk Service
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Service
          metadata:
            name: splunk-enterprise
            namespace: logging
          spec:
            type: LoadBalancer
            selector:
              app: splunk
            ports:
              - name: web
                port: 8000
                targetPort: 8000
              - name: hec
                port: 8088
                targetPort: 8088

    - name: Create Fluent Bit ServiceAccount
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: ServiceAccount
          metadata:
            name: fluent-bit
            namespace: logging

    - name: Create Fluent Bit ClusterRole
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: rbac.authorization.k8s.io/v1
          kind: ClusterRole
          metadata:
            name: fluent-bit
          rules:
            - apiGroups: [""]
              resources:
                - pods
                - namespaces
              verbs: ["get", "list", "watch"]

    - name: Bind ClusterRole to Fluent Bit SA
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: rbac.authorization.k8s.io/v1
          kind: ClusterRoleBinding
          metadata:
            name: fluent-bit
          roleRef:
            apiGroup: rbac.authorization.k8s.io
            kind: ClusterRole
            name: fluent-bit
          subjects:
            - kind: ServiceAccount
              name: fluent-bit
              namespace: logging

    - name: Create Fluent Bit ConfigMap
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: ConfigMap
          metadata:
            name: fluent-bit-config
            namespace: logging
          data:
            fluent-bit.conf: |
              [SERVICE]
                  Flush        1
                  Daemon       Off
                  Log_Level    info
                  Parsers_File parsers.conf

              @INCLUDE input-kubernetes.conf
              @INCLUDE filter-kubernetes.conf
              @INCLUDE output-splunk.conf

            input-kubernetes.conf: |
              [INPUT]
                  Name              tail
                  Path              /var/log/containers/*.log
                  multiline.parser  docker
                  Tag               kube.*
                  Refresh_Interval  5
                  Mem_Buf_Limit     50MB
                  Skip_Long_Lines   On

            filter-kubernetes.conf: |
              [FILTER]
                  Name                kubernetes
                  Match               kube.*
                  Merge_Log           On
                  Keep_Log            Off
                  Kube_URL            https://kubernetes.default.svc
                  Kube_CA_File        /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
                  Kube_Token_File     /var/run/secrets/kubernetes.io/serviceaccount/token
                  Kube_Tag_Prefix     kube.var.log.containers.
                  Use_Kubelet         Off

            output-splunk.conf: |
              [OUTPUT]
                  Name              splunk
                  Match             kube.*
                  Host              splunk-enterprise.logging.svc.cluster.local
                  Port              8088
                  Splunk_Token      my-hec-token
                  TLS               Off
                  event_index       main
                  event_sourcetype  k8s:container:log
                  compress          gzip

            parsers.conf: |
              [PARSER]
                  Name        docker
                  Format      json
                  Time_Key    time
                  Time_Format %Y-%m-%dT%H:%M:%S.%LZ
                  Time_Keep   On

    - name: Deploy Fluent Bit DaemonSet
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: apps/v1
          kind: DaemonSet
          metadata:
            name: fluent-bit
            namespace: logging
            labels:
              app: fluent-bit
          spec:
            selector:
              matchLabels:
                app: fluent-bit
            template:
              metadata:
                labels:
                  app: fluent-bit
              spec:
                serviceAccountName: fluent-bit
                tolerations:
                  - operator: Exists
                    effect: NoSchedule
                containers:
                  - name: fluent-bit
                    image: fluent/fluent-bit:2.2
                    volumeMounts:
                      - name: varlog
                        mountPath: /var/log
                      - name: dockercontainers
                        mountPath: /var/lib/docker/containers
                        readOnly: true
                      - name: fluent-bit-config
                        mountPath: /fluent-bit/etc/
                volumes:
                  - name: varlog
                    hostPath:
                      path: /var/log
                  - name: dockercontainers
                    hostPath:
                      path: /var/lib/docker/containers
                  - name: fluent-bit-config
                    configMap:
                      name: fluent-bit-config
