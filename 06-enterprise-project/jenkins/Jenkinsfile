pipeline {
    agent any

    environment {
        AWS_REGION = 'ap-south-1'
        AWS_ACCOUNT_ID = credentials('aws_account_id')
        ECR_REPO = 'enterprise-devops-app'
        IMAGE_TAG = "${env.BUILD_NUMBER}"
        DOCKER_IMAGE = "${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/${ECR_REPO}:${IMAGE_TAG}"

        // Ensure Ansible finds kubeconfig
        K8S_AUTH_KUBECONFIG = "${WORKSPACE}/.kube/config"
    }

    stages {

        stage('Checkout Code') {
            steps {
                git branch: 'main', url: 'https://github.com/kesavandevops/devops-portfolio.git'
            }
        }

        // stage('Build Docker Image') {
        //     steps {
        //         dir('06-enterprise-project/app') {
        //             sh 'docker build -t $DOCKER_IMAGE .'
        //         }
        //     }
        // }

        // stage('Scan Docker Image with Trivy') {
        //     steps {
        //         sh "trivy image --severity HIGH,CRITICAL --exit-code 1 $DOCKER_IMAGE"
        //     }
        // }

        // stage('Login to AWS ECR') {
        //     steps {
        //         withAWS(credentials: 'aws_creds', region: "${AWS_REGION}") {
        //             sh '''
        //             aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin $AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com
        //             '''
        //         }
        //     }
        // }

        // stage('Push Docker Image') {
        //     steps {
        //         sh 'docker push $DOCKER_IMAGE'
        //     }
        // }

        // stage('Set Kubernetes Context') {
        //     steps {
        //         withAWS(credentials: 'aws_creds', region: "${AWS_REGION}") {

        //             // Create kubeconfig inside workspace so ansible can see it
        //             sh '''
        //             mkdir -p $WORKSPACE/.kube

        //             aws eks update-kubeconfig \
        //               --name enterprise-eks-cluster \
        //               --region ${AWS_REGION} \
        //               --kubeconfig $WORKSPACE/.kube/config
        //             '''

        //             sh 'kubectl get ns'   // validation
        //         }
        //     }
        // }

        // stage('Deploy Application (Ansible)') {
        //     steps {
        //         withAWS(credentials: 'aws_creds', region: "${AWS_REGION}") {

        //             dir('06-enterprise-project/ansible') {
        //                 sh '''
        //                 echo "Using kubeconfig: $K8S_AUTH_KUBECONFIG"

        //                 ansible-playbook -i inventory/hosts.ini playbooks/deploy.yaml \
        //                   -e "kubeconfig=$K8S_AUTH_KUBECONFIG"
        //                 '''
        //             }
        //         }
        //     }
        // }

        // stage('Configure Logging') {
        //     steps {
        //         withAWS(credentials: 'aws_creds', region: "${AWS_REGION}") {
        //             dir('06-enterprise-project/ansible') {
        //                 sh '''
        //                 ansible-playbook -i inventory/hosts.ini playbooks/configure-logging.yaml \
        //                   -e "kubeconfig=$K8S_AUTH_KUBECONFIG"
        //                 '''
        //             }
        //         }
        //     }
        // }
        
        // stage('Configure Monitoring') {
        //     steps {
        //         withAWS(credentials: 'aws_creds', region: "${AWS_REGION}") {
        //             dir('06-enterprise-project/ansible') {
        //                 sh '''
        //                 ansible-playbook -i inventory/hosts.ini playbooks/configure-monitoring.yaml \
        //                   -e "kubeconfig=$K8S_AUTH_KUBECONFIG"
        //                 '''
        //             }
        //         }
        //     }
        // }
    }

    post {
        success {
            slackSend(channel: '#devops-alerts', color: 'good', message: "✅ Deployment succeeded! Image: $DOCKER_IMAGE")
        }
        failure {
            slackSend(channel: '#devops-alerts', color: 'danger', message: "❌ Deployment failed! Check Jenkins logs.")
        }
    }
}


